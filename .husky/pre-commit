#!/usr/bin/env sh
# æª¢æŸ¥æ˜¯å¦æœ‰ Supabase migration æª”æ¡ˆè¢«ä¿®æ”¹
MIGRATION_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^supabase/migrations/.*\.sql$" || true)

if [ -n "$MIGRATION_FILES" ]; then
  echo "ğŸ” æª¢æ¸¬åˆ° Supabase migration æª”æ¡ˆè®Šæ›´ï¼ŒåŸ·è¡Œå®‰å…¨æª¢æŸ¥..."

  # æª¢æŸ¥æ˜¯å¦æœ‰ç¦æ­¢çš„ search_path æ¨¡å¼
  FORBIDDEN_PATTERNS=$(echo "$MIGRATION_FILES" | xargs grep -n "SET search_path = public" 2>/dev/null || true)

  if [ -n "$FORBIDDEN_PATTERNS" ]; then
    echo ""
    echo "âŒ éŒ¯èª¤ï¼šç™¼ç¾ç¦æ­¢çš„ search_path è¨­å®šï¼"
    echo ""
    echo "$FORBIDDEN_PATTERNS"
    echo ""
    echo "âš ï¸  æ‰€æœ‰å‡½æ•¸å¿…é ˆä½¿ç”¨ SET search_path = '' (ç©ºå­—ä¸²)"
    echo "è«‹ä¿®æ­£å¾Œå†æ¬¡æäº¤ã€‚"
    echo ""
    echo "æ­£ç¢ºç¯„ä¾‹ï¼š"
    echo "  SET search_path = ''  -- âœ… æ­£ç¢º"
    echo ""
    echo "éŒ¯èª¤ç¯„ä¾‹ï¼š"
    echo "  SET search_path = public, pg_temp  -- âŒ éŒ¯èª¤"
    echo "  SET search_path = public           -- âŒ éŒ¯èª¤"
    echo ""
    exit 1
  fi

  # åŸ·è¡Œ Supabase linter
  echo "ğŸ” åŸ·è¡Œ Supabase è³‡æ–™åº« linter..."
  if ! supabase db lint --level warning 2>/dev/null; then
    echo ""
    echo "âš ï¸  è­¦å‘Šï¼šSupabase linter ç™¼ç¾å•é¡Œ"
    echo "è«‹åŸ·è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹è©³ç´°è³‡è¨Šï¼š"
    echo "  supabase db lint --level warning"
    echo ""
    echo "å»ºè­°åœ¨ä¿®æ­£è­¦å‘Šå¾Œå†æäº¤ï¼Œä½†ä¸å¼·åˆ¶ä¸­æ–·æäº¤æµç¨‹ã€‚"
    echo "æŒ‰ Ctrl+C å–æ¶ˆæäº¤ï¼Œæˆ–ç­‰å¾… 5 ç§’å¾Œç¹¼çºŒ..."
    sleep 5
  else
    echo "âœ… Supabase linter æª¢æŸ¥é€šé"
  fi

  echo ""
  echo "âœ… Migration æª”æ¡ˆå®‰å…¨æª¢æŸ¥å®Œæˆ"
  echo ""
fi

# åŸ·è¡Œæ¨™æº–çš„ lint-stagedï¼ˆåŒ…å« oxlint + typecheckï¼‰
pnpm lint-staged

oxfmt --no-error-on-unmatched-pattern
