/**
 * Supabase Server 工具函式
 *
 * 此模組提供 Server-side Supabase 存取工具：
 * - getServerSupabaseClient(): 取得 Service Role Client（無 RLS 限制）
 * - getSupabaseWithContext(event): 取得設定 Application Context 的 Client
 * - requireAuth(): 要求使用者已登入
 * - requireRole(): 要求使用者具有特定角色
 *
 * @module server/utils/supabase
 */

import { createClient, type SupabaseClient } from '@supabase/supabase-js'
import type { H3Event } from 'h3'
import type { Database } from '~~/app/types/database.types'

import { logger } from './logger'

/** User role type - 根據你的需求調整 */
type UserRole = 'admin' | 'manager' | 'staff' | 'unauthorized'

/** Session User 型別 */
interface SessionUser {
  id: string
  email: string
  name?: string
  picture?: string
  role: UserRole
  // 根據需要添加更多欄位
}

// Module-level singleton
let serviceClient: SupabaseClient<Database> | null = null

/**
 * 取得 Supabase Service Role Client（Singleton）
 *
 * 此 Client 使用 Service Role Key，繞過所有 RLS 限制。
 * 用於：
 * - OAuth 登入流程中建立使用者記錄
 * - 系統級操作（非使用者觸發）
 *
 * ⚠️ 注意：此 Client 無 RLS 保護，請謹慎使用！
 */
export function getServerSupabaseClient(): SupabaseClient<Database> {
  if (serviceClient) {
    return serviceClient
  }

  const supabaseUrl = process.env.SUPABASE_URL
  const serviceKey = process.env.SUPABASE_SECRET_KEY

  if (!supabaseUrl || !serviceKey) {
    throw createError({
      statusCode: 500,
      message: '伺服器設定錯誤',
    })
  }

  serviceClient = createClient<Database>(supabaseUrl, serviceKey, {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  })

  return serviceClient
}

/**
 * 取得設定 Application Context 的 Supabase Client
 *
 * 此函式會：
 * 1. 從 Session 取得使用者資訊
 * 2. 建立新的 Supabase Client
 * 3. 呼叫 core.set_app_context() 設定 RLS Context
 *
 * 適用於需要 RLS 保護的操作。
 *
 * @param event - H3 Event
 * @returns Supabase Client with Application Context set
 */
export async function getSupabaseWithContext(event: H3Event): Promise<SupabaseClient<Database>> {
  // 1. 取得 Session（根據你使用的認證套件調整）
  const session = await getUserSession(event)

  if (!session.user) {
    throw createError({
      statusCode: 401,
      message: '未授權：尚未登入',
    })
  }

  const user = session.user as SessionUser
  const userId = user.id
  const userRole = user.role

  // 2. 建立 Client
  const supabaseUrl = process.env.SUPABASE_URL
  const serviceKey = process.env.SUPABASE_SECRET_KEY

  if (!supabaseUrl || !serviceKey) {
    throw createError({
      statusCode: 500,
      message: '伺服器設定錯誤',
    })
  }

  const client = createClient<Database>(supabaseUrl, serviceKey, {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  })

  // 3. 設定 Application Context
  // TODO: 根據你的 schema 調整
  const core = client.schema('core')
  const { error } = await (core.rpc as any)('set_app_context', {
    p_user_id: userId,
    p_user_role: userRole,
  })

  if (error) {
    logger.error('Failed to set application context', { error, userId })
    throw createError({
      statusCode: 500,
      message: '系統暫時無法處理您的請求，請稍後再試',
    })
  }

  return client
}

/**
 * 要求使用者必須已登入（用於 API 路由）
 *
 * @param event - H3 Event
 * @returns 使用者資訊
 * @throws 401 Unauthorized
 */
export async function requireAuth(event: H3Event): Promise<SessionUser> {
  // 根據你使用的認證套件調整
  const session = await getUserSession(event)

  if (!session.user) {
    throw createError({
      statusCode: 401,
      message: '未授權',
    })
  }

  return session.user as SessionUser
}

/**
 * 要求使用者必須具有特定角色
 *
 * @param event - H3 Event
 * @param allowedRoles - 允許的角色列表
 * @returns 使用者資訊
 * @throws 401 Unauthorized or 403 Forbidden
 */
export async function requireRole(event: H3Event, allowedRoles: UserRole[]): Promise<SessionUser> {
  const user = await requireAuth(event)

  if (!allowedRoles.includes(user.role)) {
    throw createError({
      statusCode: 403,
      message: `權限不足：需要以下角色之一：${allowedRoles.join(', ')}`,
    })
  }

  return user
}

// ============================================
// 以下函式根據需要選用或調整
// ============================================

/**
 * 檢查 Email 是否在白名單中
 *
 * 白名單支援：
 * - 完整 email 比對：`user@example.com`
 * - 網域比對：`*@example.com`
 *
 * @param supabase - Supabase Client（需 Service Role）
 * @param email - 要檢查的 Email
 * @returns 是否允許登入
 */
export async function isEmailAllowed(
  supabase: SupabaseClient<Database>,
  email: string
): Promise<boolean> {
  const emailLower = email.toLowerCase()
  const domain = emailLower.split('@')[1]

  // 查詢白名單（根據你的 schema 調整）
  const core = supabase.schema('core')
  const { data, error } = await core
    .from('allowed_emails')
    .select('email')
    .or(`email.eq.${emailLower},email.eq.*@${domain}`)
    .limit(1)

  if (error) {
    logger.error('Failed to check email whitelist', { error, email: emailLower })
    return false
  }

  return data && data.length > 0
}

/**
 * 記錄認證事件（可選）
 *
 * @param supabase - Supabase Client
 * @param params - 事件參數
 */
export async function logAuthEvent(
  supabase: SupabaseClient<Database>,
  params: {
    userId: string
    eventType: 'login' | 'logout' | 'token_refreshed' | 'user_updated'
    userEmail?: string
    ipAddress?: string
    userAgent?: string
    metadata?: Record<string, unknown>
  }
): Promise<void> {
  // 根據你的 schema 調整
  const core = supabase.schema('core')

  const { error } = await (core.rpc as any)('log_auth_event', {
    p_user_id: params.userId,
    p_event_type: params.eventType,
    p_user_email: params.userEmail ?? null,
    p_ip_address: params.ipAddress ?? null,
    p_user_agent: params.userAgent ?? null,
    p_metadata: params.metadata ?? {},
  })

  if (error) {
    logger.error('Failed to log auth event', { error, params })
  }
}
